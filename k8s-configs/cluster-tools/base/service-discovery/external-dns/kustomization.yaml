kind: Kustomization
apiVersion: kustomize.config.k8s.io/v1beta1

namespace: external-dns

resources:
- namespace.yaml
# - external-dns-serviceaccount.yaml
# - external-dns-clusterrole.yaml
# - external-dns-clusterrolebinding.yaml
# - external-dns-deployment.yaml

# patches:
# - target:
#   kind: Deployment
#   name: external-dns
#   patch: |
#     - op: add
#       path: /metadata/labels
#       value:
#           app: external-dns

#     ### For ExternalDNS to be able to read Kubernetes and AWS token files
#     - op: add 
#       path: /spec/template/spec/securityContext
#           fsGroup: 65534 

#     - op: add
#       path: /spec/template/spec/containers/0/resources
#       value:
#           limits:
#             cpu: 500m
#             memory: 512Mi
#           requests:
#             cpu: 300m
#             memory: 256Mi

#     - op: replace
#       path: /spec/template/spec/containers/0/args
#       value:
#           - --source=service
#           - --source-ingress
#           - --provider=aws
#           - --policy=upsert-only # would prevent ExternalDNS from deleting any records, omit to enable full synchronization
#           - --aws-zone-type=public # only look at public hosted zones (valid values are public, private or no value for both)
#           - --registry=txt
#           - --publish-internal-services
#           - --log-level=error

#     - op: replace
#       path: /spec/template/spec/containers/0/image
#       value: public.ecr.aws/r2h3l6e4/pingcloud-clustertools/external-dns/external-dns:v0.14.2